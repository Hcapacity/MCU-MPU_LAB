/*
 * fsm_config_state.h
 *
 *  Created on: Nov 21, 2025
 *      Author: Admin
 */

#include "fsm_config_state.h"


void fsm_processing_red_trafficlight(){
	if(system_state == CONFIG_STATE && setting_state == CONFIG_RED_STATE){
		RGB_TrafficLight_Blink(RGB_tl1, 0);
		RGB_TrafficLight_Blink(RGB_tl2, 0);
	}
}


void fsm_fixedred_state(){
	if(system_state == CONFIG_STATE && setting_state == CONFIG_RED_STATE){
		if(is_button_pressed(&btn[0])){
			if(Red_Counter != Pre_Red_Counter){
				Pre_Red_Counter = Red_Counter;
			}
			index_led = 0;
			system_state = FIX_YELLOW_STATE;
			updateClockBuffer(system_state, Pre_Yellow_Counter);
		}
		else{
			if(is_button_pressed_1s(&btn[1])){
				Pre_Red_Counter++;
				if(Pre_Red_Counter >= 100) Pre_Red_Counter = 1;
				updateClockBuffer(system_state, Pre_Red_Counter);
				index_led = 0;
			}
			else{
				if(is_button_pressed(&btn[1])){
					Pre_Red_Counter++;
					if(Pre_Red_Counter >= 100) Pre_Red_Counter = 1;
					updateClockBuffer(system_state, Pre_Red_Counter);
					index_led = 0;
				}
			}

			if(is_button_pressed(&btn[2])){
				Red_Counter = Pre_Red_Counter;
			}

		}
	}
}


void fsm_processing_yellow_trafficlight(){
	if(system_state == CONFIG_STATE && setting_state == CONFIG_YELLOW_STATE){
		RGB_TrafficLight_Blink(RGB_tl1, 2);
		RGB_TrafficLight_Blink(RGB_tl2, 2);
	}
}

void fsm_fixedyellow_state(){
			// Blink Yellow Led 2hz
			// Button2 -> increase the time duration value for Yellow LEDs (press -> increase 1, hold press -> increase 1 each second)
			// Note: Range Yellow Counter = 1-99
			// Button3 -> Set value
	if(system_state == CONFIG_STATE && setting_state == CONFIG_YELLOW_STATE){
		if(is_button_pressed(&btn[0])){
			if(Yellow_Counter != Pre_Yellow_Counter){
				Pre_Yellow_Counter = Yellow_Counter;
			}
			index_led = 0;
			system_state = FIX_GREEN_STATE;
			updateClockBuffer(system_state, Pre_Green_Counter);
		}
		else{
			if(is_button_pressed_1s(&btn[1])){
				Pre_Yellow_Counter++;
				if(Pre_Yellow_Counter >= 100) Pre_Yellow_Counter = 1;
				updateClockBuffer(system_state, Pre_Yellow_Counter);
				index_led = 0;
			}
			else {
				if(is_button_pressed(&btn[1])){
					Pre_Yellow_Counter++;
					if(Pre_Yellow_Counter >= 100) Pre_Yellow_Counter = 1;
					updateClockBuffer(system_state, Pre_Yellow_Counter);
					index_led = 0;
				}
			}

			if(is_button_pressed(&btn[2])){
				Yellow_Counter = Pre_Yellow_Counter;
			}

		}
	}
}


void fsm_processing_green_trafficlight(){
	if(system_state == CONFIG_STATE && setting_state == CONFIG_GREEN_STATE){
		RGB_TrafficLight_Blink(RGB_tl1, 1);
		RGB_TrafficLight_Blink(RGB_tl2, 1);
	}
}

void fsm_fixedgreen_state(){
	if(system_state == CONFIG_STATE && setting_state == CONFIG_GREEN_STATE){
		if(is_button_pressed(&btn[0])){
			index_led = 0;

			if(Green_Counter != Pre_Green_Counter){
				Pre_Green_Counter = Green_Counter;
			}

			uint8_t Red_Check = Green_Counter + Yellow_Counter;
			if(Red_Counter != Red_Check){
				Pre_Red_Counter = DURATION_RED;
				Pre_Yellow_Counter = DURATION_YELLOW;
				Pre_Green_Counter = DURATION_GREEN;

				Red_Counter = DURATION_RED;
				Yellow_Counter = DURATION_YELLOW;
				Green_Counter = DURATION_GREEN;
			}

			Red_Counter_temp1 = Red_Counter;
			Yellow_Counter_temp1 = Yellow_Counter;
			Green_Counter_temp1 = Green_Counter;

			Red_Counter_temp2 = Red_Counter;
			Yellow_Counter_temp2 = Yellow_Counter;
			Green_Counter_temp2 = Green_Counter;

			updateClockBuffer(Red_Counter_temp1, Green_Counter_temp2);
			RGB_TrafficLight_TurnOn(RGB_tl1, RED_STATE);
			RGB_TrafficLight_TurnOn(RGB_tl2, GREEN_STATE);
			light_state1 = RED_STATE;
			light_state2 = GREEN_STATE;
			system_state = AUTO_STATE;
		}
		else{
			if(is_button_pressed_1s(&btn[1])){
				Pre_Green_Counter++;
				if(Pre_Green_Counter >= 100) Pre_Green_Counter = 1;
				updateClockBuffer(system_state, Pre_Green_Counter);
				index_led = 0;
			}
			else {
				if(is_button_pressed(&btn[1])){
					Pre_Green_Counter++;
					if(Pre_Green_Counter >= 100) Pre_Green_Counter = 1;
					updateClockBuffer(system_state, Pre_Green_Counter);
					index_led = 0;
				}
			}

			if(is_button_pressed(&btn[2])){
				Green_Counter = Pre_Green_Counter;
			}
		}
	}
}
