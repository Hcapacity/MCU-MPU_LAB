/*
 * check_rc.c
 *
 *  Created on: Dec 2, 2025
 *      Author: Admin
 */


#include "check_rc.h"

#define MAX_INDEX 50

uint8_t dataRx;
uint8_t receive_flag = 0;
uint8_t buffer[BUFFER_LEN];
uint16_t buffer_index;
uint8_t buffer_flag = 0;


void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart){
	if(huart->Instance == huart2.Instance){
		if( dataRx == '!')
		{
			receive_flag = 1;
		}

		if(receive_flag){
			buffer[buffer_index++] = dataRx;
			if(buffer_index >= MAX_INDEX) buffer_index = 0;

			if(dataRx == '#'){
				receive_flag = 0;
				buffer_flag = 1;
			}
		}
		HAL_UART_Transmit(&huart2, &dataRx, 1, 10);

		HAL_UART_Receive_IT(&huart2, &dataRx, 1);
	}

}

void uart_init(){
	HAL_UART_Receive_IT(&huart2, &dataRx, 1);
}



uint8_t state = IDLE;
uint16_t current_index = 0;
uint16_t start_index = 0;
uint16_t end_index = 0;

uint8_t cmd_flag = 0;
char* cmd_str;




// find index function
uint8_t find_char(char* str, uint16_t* index, char character){
	uint8_t count = 0;
	uint8_t cur = *index;
	while(str[(*index)] != character){
		(*index)++;
		count++;
		if(*index >= MAX_INDEX) *index = 0;
		if(count >= MAX_INDEX) {
			*index = cur;
			return 0;
		}
	}
    return 1;
}
// cut string function
char* substring(char* str, uint16_t start, uint16_t end){
	uint16_t len = 0;
	if(end > start){
		len = end - start + 1;
	}
	else{
		len = end + MAX_INDEX - start + 1;
	}
	char* sub = (char*)malloc(len+1);// them 1 cho cho '\0'

    for(int i = 0; i < len; ++i){
    	sub[i] = str[(start + i) % MAX_INDEX];
    }
    sub[len] = '\0';
    return sub;
}


void check_str_fsm(){
	 switch(state){
	 	 case IDLE:
	 		 if(buffer_flag)
	 		 {
	 			 state = FIND_START;
	 		 }
	 		 break;
	 	 case FIND_START:

	 		 if(find_char((char*)buffer, &current_index, '!')){
	 			 start_index = current_index;
	 			 current_index = (current_index + 1) % MAX_INDEX;
	 			 state = FIND_END;
	 		 }
	 		 break;
	 	 case FIND_END:
	 		 if(find_char((char*)buffer, &current_index, '#')){
	 			 end_index = current_index;
	 			 buffer_flag = 0;

	 			 // cắt cmd_string ra từ string
	 			 if(end_index == 0){
	 				end_index = MAX_INDEX - 1;
	 			 }
	 			 else end_index--;

	 			 if(start_index == MAX_INDEX - 1){
	 				 start_index = 0;
	 			 }
	 			 else start_index++;
	 			 cmd_str = substring((char*)buffer, start_index, end_index);
	 			 cmd_flag = 1;
	 			 state = IDLE;
	 		 }

	 		 break;
	 }

}
