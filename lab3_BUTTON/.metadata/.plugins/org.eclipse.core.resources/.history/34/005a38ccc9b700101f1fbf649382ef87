/*
 * Process.c
 *
 *  Created on: Nov 2, 2025
 *      Author: Admin
 */

#include "Process.h"

static uint8_t system_state = 0;
static uint8_t light_state1 = RED_STATE;
static uint8_t light_state2 = GREEN_STATE;

static uint8_t Pre_Red_Counter = DURATION_RED;
static uint8_t Pre_Yellow_Counter = DURATION_YELLOW;
static uint8_t Pre_GREEN_Counter = DURATION_GREEN;

static uint8_t Red_Counter = DURATION_RED;
static uint8_t Yellow_Counter = DURATION_YELLOW;
static uint8_t GREEN_Counter = DURATION_GREEN;

static uint8_t Red_Counter_temp = DURATION_RED;
static uint8_t Yellow_Counter_temp = DURATION_YELLOW;
static uint8_t GREEN_Counter_temp = DURATION_GREEN;


// Timer0 -> 1s (Change Value of 7seg, Duration for LEDs)
// Timer1 -> 250ms (Blink LEDs)
// Timer2 -> 50ms (Scan LEDs)

void fsm_processing_trafficlight(RGB_TrafficLight_t* RGB_tl1, RGB_TrafficLight_t* RGB_tl2){
	int num1, num2;

	switch(light_state1){
	case RED_STATE:
		RGB_TrafficLight_TurnOn(RGB_tl1, 0);
		if(Red_Counter_temp == 0){
			Red_Counter_temp = Red_counter;
			light_state1 = GREEN_STATE;
			break;
		}
		num1 = Red_Counter_temp;
		if(timer_flag[0] == 1){
			Red_Counter_temp--;
			settimer_index(0, 1000);
		}
		break;
	case GREEN_STATE:
		RGB_TrafficLight_TurnOn(RGB_tl1, 1);
		if(GREEN_Counter_temp == 0){
			GREEN_Counter_temp = GREEN_counter;
			light_state1 = YELLOW_STATE;
			break;
		}
		num1 = GREEN_Counter_temp;
		if(timer_flag[0] == 1){
			GREEN_Counter_temp--;
			settimer_index(0, 1000);
		}
		break;
	case YELLOW_STATE:
		RGB_TrafficLight_TurnOn(RGB_tl1, 2);
		if(Yellow_Counter_temp == 0){
			Yellow_Counter_temp = Yellow_counter;
			light_state1 = RED_STATE;
			break;
		}
		num1 = Yellow_Counter_temp;
		if(timer_flag[0] == 1){
			Yellow_Counter_temp--;
			settimer_index(0, 1000);
		}
		break;
	}

	switch(light_state2){
	case RED_STATE:
		RGB_TrafficLight_TurnOn(RGB_tl2, 0);
		if(Red_Counter_temp == 0){
			Red_Counter_temp = Red_counter;
			light_state2 = GREEN_STATE;
			break;
		}
		num2 = Red_Counter_temp;
		if(timer_flag[0] == 1){
			Red_Counter_temp--;
			settimer_index(0, 1000);
		}
		break;
	case GREEN_STATE:
		RGB_TrafficLight_TurnOn(RGB_tl2, 1);
		if(GREEN_Counter_temp == 0){
			GREEN_Counter_temp = GREEN_counter;
			light_state2 = YELLOW_STATE;
			break;
		}
		num2 = GREEN_Counter_temp;
		if(timer_flag[0] == 1){
			GREEN_Counter_temp--;
			settimer_index(0, 1000);
		}
		break;
	case YELLOW_STATE:
		RGB_TrafficLight_TurnOn(RGB_tl2, 2);
		if(Yellow_Counter_temp == 0){
			Yellow_Counter_temp = Yellow_counter;
			light_state2 = RED_STATE;
			break;
		}
		num2 = Yellow_Counter_temp;
		if(timer_flag[0] == 1){
			Yellow_Counter_temp--;
			settimer_index(0, 1000);
		}
		break;
	}

	if(timer_flag[2] == 1){
		Scan_Led(num1, num2);
		settimer_index(2, 50);
	}

}


//*************************************//
// RULE: IF AFTER SAVE GREEN STATE, RED_DURATION != YELLOW_DURATION + GREEN_DURATION --> SET THE DEFAULT VALUE FOR THEM! //
void fsm_processing_system(btn_typedef* btn ){
	switch(System_state){
	case AUTO_STATE:
		// Run Traffic Light normally
		fsm_processing_trafficlight();

		if(is_button_pressed(&btn[0])){
			System_state = FIX_RED_STATE;

			RGB_TrafficLight_Blink(RGB_tl1, 0);
			RGB_TrafficLight_Blink(RGB_tl2, 0);

			settimer_index(1, 250);
		}
		break;

	case FIX_RED_STATE:
		// Blink Red Led 2hz
		// Button2 -> increase the time duration value for red LEDs (press -> increase 1, hold press -> increase 1 each second)
		// Note: Range Led Counter = 1-99
		// Button3 -> Set value (value isnot saved if dont press this Button)

		if(timer_flag[1] == 1){
			RGB_TrafficLight_Blink(RGB_tl1, 0);
			RGB_TrafficLight_Blink(RGB_tl2, 0);

			settimer_index(1, 250);
		}

		settimer_index(3, 10);
		if(is_button_pressed(&btn[1]) && timer_flag[3] == 1){
			settimer_index(3, 1000);
			Pre_Red_Counter++;
		}

		if(is_button_pressed(&btn[2])){
			Red_Counter = Pre_Red_Counter;
		}

		//Scan LED
		if(timer_flag[2] == 1){
			Scan_Led(System_state, Pre_Red_Counter);
			settimer_index(2, 50);
		}

		if(is_button_pressed(&btn[0])){
			if(Red_Counter != Pre_Red_Counter){
				Pre_Red_Counter = Red_Counter;
			}
			System_state = FIX_YELLOW_STATE;

			RGB_TrafficLight_Blink(RGB_tl1, 2);
			RGB_TrafficLight_Blink(RGB_tl2, 2);

			settimer_index(1, 250);
		}

		break;
	case FIX_YELLOW_STATE:
		// Blink Yellow Led 2hz
		// Button2 -> increase the time duration value for Yellow LEDs (press -> increase 1, hold press -> increase 1 each second)
		// Note: Range Yellow Counter = 1-99
		// Button3 -> Set value

		if(timer_flag[1] == 1){
			RGB_TrafficLight_Blink(RGB_tl1, 2);
			RGB_TrafficLight_Blink(RGB_tl2, 2);

			settimer_index(1, 250);
		}

		settimer_index(3, 10);
		if(is_button_pressed(&btn[1]) && timer_flag[3] == 1){
			settimer_index(3, 1000);
			Pre_Yellow_Counter++;
		}

		if(is_button_pressed(&btn[2])){
			Yellow_Counter = Pre_Yellow_Counter;
		}

		//Scan LED
		if(timer_flag[2] == 1){
			Scan_Led(System_state, Pre_Yellow_Counter);
			settimer_index(2, 50);
		}

		if(is_button_pressed(&btn[0])){
			if(Yellow_Counter != Pre_Yellow_Counter){
				Pre_Yellow_Counter = Yellow_Counter;
			}
			System_state = FIX_GREEN_STATE;

			RGB_TrafficLight_Blink(RGB_tl1, 1);
			RGB_TrafficLight_Blink(RGB_tl2, 1);

			settimer_index(1, 250);
		}

		break;
	case FIX_GREEN_STATE:
		// Blink GREEN Led 2hz
		// Button2 -> increase the time duration value for GREEN LEDs (press -> increase 1, hold press -> increase 1 each second)
		// Note: Range GREEN Counter = 1-99
		// Button3 -> Set value

		if(timer_flag[1] == 1){
			RGB_TrafficLight_Blink(RGB_tl1, 1);
			RGB_TrafficLight_Blink(RGB_tl2, 1);

			settimer_index(1, 250);
		}

		settimer_index(3, 10);
		if(is_button_pressed(&btn[1]) && timer_flag[3] == 1){
			settimer_index(3, 1000);
			Pre_GREEN_Counter++;
		}

		if(is_button_pressed(&btn[2])){
			GREEN_Counter = Pre_GREEN_Counter;
		}

		//Scan LED
		if(timer_flag[2] == 1){
			Scan_Led(System_state, Pre_GREEN_Counter);
			settimer_index(2, 50);
		}

		if(is_button_pressed(&btn[0])){
			if(GREEN_Counter != Pre_GREEN_Counter){
				Pre_GREEN_Counter = GREEN_Counter;
			}

			uint8_t Red_Check = GREEN_Counter + Yellow_Counter;
			if(Red_Counter != Red_Check){
				Pre_Red_Counter = DURATION_RED;
				Pre_Yellow_Counter = DURATION_YELLOW;
				Pre_GREEN_Counter = DURATION_GREEN;

				Red_Counter = DURATION_RED;
				Yellow_Counter = DURATION_YELLOW;
				GREEN_Counter = DURATION_GREEN;
			}

			Red_Counter_temp = Red_Counter;
			Yellow_Counter_temp = Yellow_Counter;
			GREEN_Counter_temp = GREEN_Counter;

			System_state = AUTO_STATE;

		}

		break;
	}
}
