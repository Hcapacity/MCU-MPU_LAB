/*
 * Button.c
 *
 *  Created on: Oct 29, 2025
 *      Author: Admin
 */

#include "button.h"

typedef struct{
	uint16_t btn_Pin;
	GPIO_TypeDef * btn_Port;

	GPIO_PinState btn_state;
	GPIO_PinState debounceButton_1;
	GPIO_PinState debounceButton_2;
	GPIO_PinState debounceButton_3;

	uint8_t flagForButtonPress1s;
	uint8_t flagForButtonPressDouble;
	uint8_t firtpressflag;
	uint16_t counterForButtonPress1s;
	uint16_t counterForButtonPressDouble;
}btn_typedef;

void button_reading (btn_typedef* btn){

	btn->debounceButton_3 = btn->debounceButton_2;
	btn->debounceButton_2 = btn->debounceButton_1;
	btn->debounceButton_1 = HAL_GPIO_ReadPin(btn->btn_Port, btn->btn_Pin);

	// update state of button
	if( btn->debounceButton_3 == btn->debounceButton_1)
		btn->btn_state = btn->debounceButton_1;

	// checking press 1s
	if(btn->btn_state == BUTTON_IS_PRESSED){
		if( btn->counterForButtonPress1s < DURATION_FOR_AUTO_INCREASING ){
			++btn->counterForButtonPress1s;
		} else {
		btn->flagForButtonPress1s = 1;
		}
	} else {
		btn->counterForButtonPress1s = 0;
		btn->flagForButtonPress1s = 0;
	}

	// checking press double
	if(btn->btn_state == BUTTON_IS_PRESSED && btn->firtpressflag == 0){
		btn->firtpressflag = 1;
		btn->counterForButtonPressDouble = 0;
	}

	if(btn->firtpressflag == 1){
		if(btn->counterForButtonPressDouble >= DOUBLE_PRESS_CHECKIN
				&& btn->counterForButtonPressDouble < DOUBLE_PRESS_TIMEOUT){
			if(btn->btn_state == BUTTON_IS_PRESSED){
				btn->flagForButtonPressDouble = 1;
				btn->firtpressflag = 0;
				btn->counterForButtonPressDouble = 0;
			}
		}

		if(btn->counterForButtonPressDouble >= DOUBLE_PRESS_TIMEOUT){
			btn->firtpressflag = 0;
			btn->counterForButtonPressDouble = 0;
		}
		++btn->counterForButtonPressDouble;
	}

}

unsigned char is_button_pressed (btn_typedef* btn){
	return ( btn->btn_state == BUTTON_IS_PRESSED );
}

unsigned char is_button_pressed_1s (btn_typedef* btn){
	if( btn->flagForButtonPress1s == 1){
		btn->flagForButtonPress1s = 0;
		return 1;
	}
	return 0;
}

unsigned char is_button_double_press (btn_typedef* btn){
	if( btn->flagForButtonPressDouble == 1){
		btn->flagForButtonPressDouble = 0;
		return 1;
	}
	return 0;
}
